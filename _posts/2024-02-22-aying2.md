---
layout: post
title:  "Identifying Cell-types from Spleen CODEX Dataset using K-means Clustering, tSNE, and Wilcox-test"
author: Andrew Ying
jhed: aying2
categories: [ HW6 ]
image: homework/hw6/hw6_aying2.png
featured: false
---

## Describe your figure briefly so we know what you are depicting (you no longer need to use precise data visualization terms as you have been doing)
For plot A, I am visualizing the quantitative data of the X1 and X2 tSNE embedding values, and categorical data of the cluster the cell belongs to. I am using the geometric primitive of points to represent each cell. To encode the X1 embedding value, I am using the visual channel of position along the x axis. To encode the X2 value, I am using the visual channel of position along the y axis. To encode the categorical cluster the cell belongs to, I am using the visual channel of hue with orange for cluster 2, purple for cluster 6, and gray for the other clusters.

For plot B, I am visualizing the spatial data of the x and y positions for each cell, and categorical data of the cluster the cell belongs to. I am using the geometric primitive of points to represent each cell. To encode the spatial x position, I am using the visual channel of position along the x axis. To encode the spatial y position, I am using the visual channel of position along the y axis. To encode the categorical cluster the cell belongs to, I am using the visual channel of hue with orange for cluster 2, purple for cluster 6, and gray for the other clusters.

For plots C and D, I am visualizing the quantitative data of the log-transformed p-value, the quantitative data of the log-transformed fold change, and the ordinal data for the differential expression level for each gene. I am using the geometric primitive of points to represent each gene. To encode the log-transformed fold change, I am using the visual channel of position along the x axis. To encode the log-transformed p-value, I am using the visual channel of position along the y axis. To encode the differential expression level, I am using visual channel of color hue with blue representing downregulated expression, red representing upregulated expression, and grey representing no significant differential expression for a given gene.

For plot E, I am visualizing the quantitative data of the X1 and X2 tSNE embedding values, and quantitative data of normalized log-scaled CD8 expression for each cell. I am using the geometric primitive of points to represent each cell. To encode the X1 embedding value, I am using the visual channel of position along the x axis. To encode the X2 value, I am using the visual channel of position along the y axis. To encode the quantitative normalized log-scaled CD8 expression, I am using the visual channel of saturation going from an unsaturated light grey to a saturated orange.

For plot F, I am visualizing the quantitative data of the X1 and X2 tSNE embedding values, and quantitative data of normalized log-scaled Podoplanin expression for each cell. I am using the geometric primitive of points to represent each cell. To encode the X1 embedding value, I am using the visual channel of position along the x axis. To encode the X2 value, I am using the visual channel of position along the y axis. To encode the quantitative normalized log-scaled Podoplanin expression, I am using the visual channel of saturation going from an unsaturated light grey to a saturated purple.

For plot G, I am visualizing the spatial data of the x and y positions for each cell, and quantitative data of normalized log-scaled CD8 expression for each cell. I am using the geometric primitive of points to represent each cell. To encode the spatial x position, I am using the visual channel of position along the x axis. To encode the spatial y position, I am using the visual channel of position along the y axis. To encode the quantitative normalized log-scaled CD8 expression, I am using the visual channel of saturation going from an unsaturated light grey to a saturated orange.

For plot H, I am visualizing the spatial data of the x and y positions for each cell, and quantitative data of normalized log-scaled Podoplanin expression for each cell. I am using the geometric primitive of points to represent each cell. To encode the spatial x position, I am using the visual channel of position along the x axis. To encode the spatial y position, I am using the visual channel of position along the y axis. To encode the quantitative normalized log-scaled Podoplanin expression, I am using the visual channel of saturation going from an unsaturated light grey to a saturated purple.

Plots A, B, E, F, G, and H are scatter plots. Plot C and D are volcano plots.

The Gestalt principles of proximity and similarity are present because the more similar plots are adjacent. For example, A and B both involve the categorical cluster variable. C and D are both volcano plots showing differential expression. E and F are both in tSNE space and show protein expression. G and H are both in physical space and show protein expression. E and G both show CD8 expression. F and H both show Podoplanin expression. The colors used for cluster 2 (orange) and cluster 6 (purple) are also used in the saturation gradient for their most upregulated protein (CD8 and Podoplanin respectively).

The Gestalt principle of continuity is used because progressing from plot A to plot H (left to right, top to bottom) aligns with the steps used to identify clusters 2 and 6's cell-types (described below). The continuous columns formed by C down to G and D down to H, aligned with the cluster the plots refer to (2 and 6 respectively).

## interpret at least two cell-types. Create a data visualization and write a description to convince me that your interpretation is correct. 
To cluster the data, k-means clustering with k=7 was used. k=7 was found by constructing an elbow plot and picking around the elbow and choosing a number of clusters large enough for the differential expression plots to give significant results.

Clusters 2 and 6 were chosen because they appeared to be relatively well-defined in tSNE space and separate from the other clusters and each other. Also when plotted in physical space, cluster 6 appeared to be localized in the "spoon" in the center of the plot while cluster 2 was found more in the background regions of the top left and bottom right corners, so it was thought that they would make an interesting comparison.

Visualizing the cluster in physical space allowed for later comparison once a differentially upregulated protein was chosen (Figure B). For this, a two-sided Wilcox test was used comparing the protein expression levels for cluster 2 with those of the other clusters for each protein. Then another two-sided Wilcox test was used comparing the protein expression levels for cluster 6 with those of the other clusters for each protein. 

The p-values were -log10 transformed with an offset of 1e-300, so small p-values have map to high values. This offset was necessary because otherwise, the log transforms would result in infinite values, since the respective arguments of the log were so small they rounded to 0. 1e-300 was chosen because it is one of the smallest values to represent and so wouldn't change the result of the logarithm too much. Still, because of the rounding, which cells have a greater -log10 transformed p-values is unclear near the upper bound. Using whether the log2 fold change was positive or negative, the direction of the differential expression, upregulated or downregulated respectively, could be ascertained. Points with p-values >= 0.01 and with absolute value of log2 fold change less than 0.20 (fold-change of 1.15) were considered insignificant.

Finally, downregulated and upregulated proteins were labeled with their names. CD8 was chosen as a protein of interest for cluster 2 and its expression was graphed in tSNE and physical space. In the tSNE space, Cluster 2 was contained within the regions of high CD8 expression, but the regions of high CD8 expression were more vast than cluster 2, indicating that some of the other clusters likely also upregulate CD8. A similar finding was there for cluster 6 and podoplanin. These findings are likely related to the k-means clustering, since the elbow for this dataset was weaker than in previous homeworks, and the clusters are perhaps not as distinguished. For the spatial plots in physical space, the protein expression values generally aligned with the cluster locations.

For cluster 2, the top most upregulated genes (CD8, CD3e, CD45), were searched for on Human Protein Atlas to identify the cell-type the cluster corresponds to (https://www.proteinatlas.org). Knowing that the tissue sample was from the spleen, CD8 is known to have notable expression in the T-cells with the number of transcripts per million (nTPM) of 779.2 for T-cell cluster c-1 (z-score 1.28) and 542.4 nTPM for T-cell cluster c-7 (z-score 1.13) (https://www.proteinatlas.org/ENSG00000153563-CD8A/single+cell+type/spleen). This is significantly higher expression than for the other cell types (macrophages, B-cells, Plasma cells, etc), the nTPM for which are < 50. CD3e is also upregulated in the T-cells of the spleen, with an nTPM >1000 for T-cell clusters c-1, c-2, and c-7 and z-scores of ~0.87. The expression (nTPM) for the other cells types is again < 50nTPM. CD45 is upregulated in the T-cells of the spleen, with an nTPM ~1000 for T-cell clusters c-1, c-2, and c-7 and a z-score of 1.05 for c-1. The expression (nTPM) for macrophages and B-cells is also relatively high. Overall, these findings suggest that cluster 2 consists of T-cells.

For cluster 6, the top most upregulated genes were podoplanin, SMActin, and CollagenIV. Podoplanin's tissue profile states that it has "Distinct expression in alveoli, lymphatic vessels, placental and ovarian stroma, myoepithelium and basal cells of squamous epithelia" (https://www.proteinatlas.org/ENSG00000162493-PDPN). The expression for lympathic epithelial cells is significant at 304.9 nTPM. SMActin (ACTA2) is known to have "Selective expression in smooth muscle cells and myoepithelial cells" (https://www.proteinatlas.org/ENSG00000107796-ACTA2). The expression for smooth muscle cells is extremely significant at 4036.1 nTPM. CollagenIV (COL4A1) enhanced in the "Extravillous trophoblasts, Smooth muscle cells, Adipocytes, Endometrial stromal cells, Fibroblasts, Endothelial cells, Sertoli cells" (https://www.proteinatlas.org/ENSG00000187498-COL4A1). The expression for smooth muscle is significant at 412.6 nTPM. Overall, these finding suggest that cluster 6 consists of smooth muscle cells lining the vessels of the spleen. This aligns with figures B and H, which show cluster 6 and podoplanin expression concentrated around a circlular object, likely a vessel.

From this, I predict this tissue structure to be white pulp because of the high concentration of lymphocytes and organization around central vessel. The white pulp is known to be "located around a central arteriole" and "is composed of the periarteriolar lymphoid sheath (PALS, T-cell area)." (https://www.ncbi.nlm.nih.gov/pmc/articles/PMC1828535/).

## Please share the code you used to reproduce this data visualization.
```{r}
data <-
    read.csv("genomic-data-visualization-2024/data/pikachu.csv.gz",
             row.names = 1)

data[1:10, 1:10]
pos <- data[, 4:5]
gexp <- data[6:ncol(data)]

gexpnorm <- log10(gexp/rowSums(gexp) * mean(rowSums(gexp))+1)

pcs <- prcomp(gexpnorm)
plot(pcs$sdev[1:100])

# find k with elbow method
set.seed(42)
results <- sapply(seq(2, 14, by=1), function(i) {
    print(i)
    com <- kmeans(gexpnorm, centers=i)
    return(com$tot.withinss)
})
plot(results, type="l")

set.seed(42)
com <- as.factor(kmeans(gexpnorm, centers=8)$cluster)

library(Rtsne)
set.seed(42)
emb <- Rtsne(pcs$x)$Y


library(ggplot2)
df <- data.frame(pos, emb, com)
ggplot(df) + 
    geom_point(aes(x = X1, y = X2, col=com), size=1) + 
    theme_bw()

ggplot(df) + 
    geom_point(aes(x = aligned_x, y = aligned_y, col=com), size=1) + 
    theme_bw()

clusterofinterest = 4
df2 <- df
df2[com!=clusterofinterest, "com"] = 1
p1 <- ggplot(df2) + 
    geom_point(aes(x = X1, y = X2, col=com), size=0.5) +
    scale_color_manual(values = c("grey", "red"), labels = c("1, 2, 3, 5, 6, 7, 8", "4"))+
    labs(col='cluster') +
    labs(title = 'Cluster vs. X2 vs. X1 (k = 8) (tSNE Space)') +
    
    theme_bw()
p1

df3 <- data.frame(pos, df2)
p2 <- ggplot(df3) + 
    geom_point(aes(x = aligned_x, y = aligned_y, col=com), size=0.5) +
    scale_color_manual(values = c("grey", "red"), labels = c("1, 2, 3, 5, 6, 7, 8", "4"))+
    labs(col='cluster') +
    labs(title = 'Cluster vs. aligned_y vs. aligned_x (k = 8) (Physical Space)') +
    
    theme_bw()
p2

colnames(gexpnorm)

pv <- sapply(colnames(gexpnorm), function(i) {
    print(i) ## print out gene name
    wilcox.test(gexpnorm[com == clusterofinterest, i],
                gexpnorm[com != clusterofinterest, i])$p.val
})
logfc <- sapply(colnames(gexpnorm), function(i) {
    print(i) ## print out gene name
    log2(mean(gexpnorm[com == clusterofinterest, i])
         / mean(gexpnorm[com != clusterofinterest, i]) + 2^-6)
})

df4 <- data.frame(pv = pv, logpv=-log10(pv + 1e-300), logfc)
df4["gene"] <- rownames(df4)
df4["diffexp"] = "Not Significant"
df4[df4["pv"] < 0.01 & df4["logfc"] > 0.58, "diffexp"] = "Upregulated"
df4[df4["pv"] < 0.01 & df4["logfc"] < -0.58, "diffexp"] = "Downregulated"
df4$diffexp = as.factor(df4$diffexp)

levels(df4$diffexp)

library(ggrepel)

# https://ggrepel.slowkow.com/articles/examples.html#examples
p3 <- ggplot(df4) + geom_point(aes(x = logfc, y = logpv, color=diffexp)) +
    geom_text_repel(aes(label=ifelse((logpv > 290 & logfc > 1.5) 
                                     | (logpv > 250 & logfc < -1.5)
                                     | pv < 0.01 & logfc < -5.5,as.character(gene), "")
                        , x = logfc, y = logpv), size=3, max.overlaps = Inf, box.padding = .5) +
    scale_color_manual(values = c("cornflowerblue", "grey", "firebrick")) +
    ylab("-log10(pv + 1e-300)")+
    xlab("log2(fc + 2^-6)")+
    ylim(NA, 350) +
    xlim(NA, 4) +
    labs(title = 'Differential Expression vs. -log10(pv + 1e-300) vs. log2(fc + 2^-6)') +
    theme_bw()
p3

df5 <- data.frame(pos, gexpnorm, emb, com)
p4 <- ggplot(df5) + 
    geom_point(aes(x = X1, y = X2, col=KRT5), size=0.5) +
    labs(title = 'KRT5 Expression vs. X2 vs. X1 (tSNE Space)') +
    scale_color_gradient(low="grey", high="red")+
    theme_bw()
p4

p5 <- ggplot(df5) + 
    geom_point(aes(x = aligned_x, y = aligned_y, col=KRT5), size=0.5) +
    labs(title = 'KRT5 Expression vs. aligned_y vs. aligned_x (Physical Space)') +
    scale_color_gradient(low="grey", high="red")+
    theme_bw()
p5

library(patchwork)

p1 + p2 + p3 + p4 + p5 + 
    plot_annotation(tag_levels = 'A') + plot_layout(nrow = 2, ncol = 3)
```